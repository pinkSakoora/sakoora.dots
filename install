#!/bin/sh

dotpath="/home/$USER/.dotfiles"
flagpath="/home/$USER/.dotfiles/flaglist.sh"
pkglist="/home/$USER/.dotfiles/pkglist.txt"
yaypkglist="/home/$USER/.dotfiles/foreignpkglist.txt"
configfolder="/home/$USER/.config"

modifiedconfigs=("/hypr" "/dunst" "/fastfetch" "/kitty" "/waybar" "/rofi" "/scripts")

source $flagpath

s_noyay="0"

case "$1" in
	"-noyay" ) 
		s_noyay="1"
		break;;
esac

bigtext() {
cat <<"EOF"
            _                              _       _       
           | |                            | |     | |      
  ___  __ _| | _____   ___  _ __ __ _   __| | ___ | |_ ___ 
 / __|/ _` | |/ / _ \ / _ \| '__/ _` | / _` |/ _ \| __/ __|
 \__ \ (_| |   < (_) | (_) | | | (_| || (_| | (_) | |_\__ \
 |___/\__,_|_|\_\___/ \___/|_|  \__,_(_)__,_|\___/ \__|___/
                                                           
                                                           
EOF
}

confirm() {					# usage: confirm "Prompt" optional: -N
local response
local defaultresponse="Y"
local responsebox="[Y/n]"

if [ "$2" = "-N" ]; then
	responsebox="[y/N]"
	defaultresponse="N"
fi

while true; do
	read -rp "$1 $responsebox " response
	response="${response:-$defaultresponse}"
	case "$response" in
		[Yy]* )
			return 0
			;;
		[Nn]* )
			return 1
			;;
		* )
			echo "Invalid input."
			;;
	esac
done
}

execute() {
$@ | tee $logfile
exitcode=${PIPESTATUS[0]}
return $exitcode
}

command_fail() {
case "$1" in
	1 )
		echo "Failed to update pacman db. Pacman exit code: $exitcode"
		break;;
	2 )
		echo "Failed to install pacman packages. Pacman exit code: $exitcode"
		break;;
	3 )
		echo "Failed to clone yay repository. Git exit code: $exitcode"
		break;;
	4 )
		echo "Failed to build yay. Makepkg exit code: $exitcode"
		break;;
	5 )
		echo "Failed to generate development package database. Yay exit code: $exitcode"
		break;;
	6 )
		echo "Failed to update development packages. Yay exit code: $exitcode"
		break;;
	7 )
		echo "Failed to install required AUR packages. Yay exit code: $exitcode"
		break;;
	8 )
		echo "Exiting installer on user prompt [Pre-installation exit: 8]"
		exit 8;;
	9 )
		echo "Exiting installer on user prompt [Yay setup aborted: 9]"
		exit 9;;
	10 )
		echo "Exiting installer on user prompt [Configuration swap aborted: 10]"
		exit 10;;
esac
echo "Failed command logged in file located at \"$logfile\""
echo "Installation failed with status: $1"
exit $exitcode
}

test_tty() {
tty | grep -s tty && s_intty="0" || s_intty="1"
return
}

command_exists() {
command -v "$@" >/dev/null 2>&1
}

append_suffix() {
local suffix="$2"
local file="$configfolder$1"
if [ -d "$file" ]; then
	mv "$file" "$file$suffix"
fi
}

show_progress() {
	echo "Progress:"
	echo
	if [ "$s_pacman" = "0" ]; then
		echo "[ ✖ ] Required pacman packages have not been installed yet."
	else
		echo "[ ✔ ] Required pacman packages installed."
	fi
	if [ "$s_noyay" = "0" ]; then
		if [ "$s_yay" = "0" ]; then
			echo "[ ✖ ] Required AUR packages have not been installed yet."
		else
			echo "[ ✔ ] Required AUR packages installed."
		fi
	fi

	if [ "$s_config" = "0" ]; then
		echo "[ ✖ ] Config files have not been replaced yet."
	else
		echo "[ ✔ ] Config files replaced."
	fi
	
	if [ "$s_walls" = "0" ]; then
		echo -e "[ \033[1mi\033[0m ] Wallpapers available."
	fi
	echo
	test_tty
	if [ "$s_intty" = "1" ]; then
		echo -e "[ \033[1m!\033[0m ] It is detected that you're currently not on a tty! It is recommended to run this script in a tty to avoid any potential issues."
	fi
	if [ "$s_noyay" = "1" ]; then
		echo -e "[ \033[1m!\033[0m ] -noyay flag was used. Install required AUR packages in your preferred way."
	fi
	[ "$s_intty" = "0" ] && confirm "Proceed with installation?" || confirm "Proceed with installation? (Not recommended)" -N
	case "$?" in
		0 )
			return 0;;
		1 )
			command_fail 8
	esac
}

pacman_install() {
	echo "Installing all required packages..."
	echo 
	execute sudo pacman -Syu || command_fail 1
	execute sudo pacman -S --needed - < $pkglist || command_fail 2
	sed -i 's/s_pacman="0"/s_pacman="1"/' $flagpath
	return
}

setup_yay() {
	echo "The next part of the installation requires yay, which has not been detected on your system."
	confirm "Install yay now?"
	case $? in
		0 ) 
			break;;
		1 ) 
			command_fail 9
	esac
	echo "Setting up yay..."
	execute git clone https://aur.archlinux.org/yay.git || command_fail 3
	cd ~/yay
	execute makepkg -si || command_fail 4
	cd ~
	echo "Yay has been installed."
	return
}

yay_install() {
	echo "Installing yay packages..."
	execute yay -Y --gendb || command_fail 5
	execute yay -Syu --devel || command_fail 6
	execute yay -S - < $yaypkglist || command_fail 7
	sed -i 's/s_yay="0"/s_yay="1"/' $flagpath
	echo "AUR packages installed."
	return
}

config_change() {
	confirm "Proceed with changing configs?"
	case $? in
		0 )
			break;;
		1 )
			command_fail 10
	esac

	echo "Renaming preexisting config files..."
	local file
	for file in "${modifiedconfigs[@]}"; do
		append_suffix "$file" "-pre-sakoora"
	done
	echo "Old config files have been renamed to [config_folder]-pre-sakoora."

	echo "Moving config files from .dotfiles to required location..."
	mv $dotpath/.config/* $configfolder/
	echo "Done!"

	echo "Moving required font files to ~/.local/share/fonts/"
	if [ -d "/home/$USER/.local/share/fonts" ]; then
		echo "Fonts directory already exists..."
		mv $dotpath/fonts/* /home/$USER/.local/share/fonts/
	elif [ -d "/home/$USER/.local/share" ]; then
		mv $dotpath/fonts /home/$USER/.local/share/
	else
		mkdir /home/$USER/.local/share
		mv $dotpath/fonts /home/$USER/.local/share/
	fi
	echo "Moved!"
	sed -i 's/s_config="0"/s_config="1"/' $flagpath
	return
}

wallpapers() {
	confirm "Do you want wallpapers?"
	case "$?" in
		0 )
			echo "wallset command requires any wallpapers to be located in /home/$USER/Pictures/Wallpapers/ for it to work."
			break;;
		1 )
			return;;
	esac
	git clone --single-branch --branch media https://github.com/pinkSakoora/.dotfiles.git $dotpath/walls
	mkdir -p /home/$USER/Pictures/Wallpapers
	mv $dotpath/walls/Wallpapers/* /home/$USER/Pictures/Wallpapers/
	echo "Wallpapers moved!"
	echo "Set a wallpaper using wallset command in terminal. wallset runs pywal which is needed for waybar to load."
	sed -i 's/s_walls="0"/s_walls="1"/' $flagpath
}

main() {
logfile="/home/$USER/.dotfiles/s_info$$.log"
touch logfile
bigtext
show_progress
[ "$s_pacman" = "0" ] && \
	pacman_install
if ! command_exists yay; then
	setup_yay
fi
[ "$s_yay" = "0" ] && \
	yay_install
[ "$s_config" = "0" ] && \
	config_change
[ "$s_walls" = "0" ] && \
	wallpapers
bigtext
echo "Installation complete!"
echo "Reboot your system and log into hyprland to enjoy your new config."
exit
}

cd ~
clear
main
